name: Terraform CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v2

    - name: 'Setup Google Cloud SDK'
      uses: google-github-actions/setup-gcloud@v0.2.1
      with:
        version: 'latest'
        service_account_key: ${{ secrets.GCP_CREDENTIALS }}
        export_default_credentials: true

    - name: 'Set up Terraform'
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.0.0

    - name: 'Terraform Init'
      id: init
      run: |
        cd infra
        terraform init

    - name: 'Terraform Format'
      id: fmt
      run: |
        cd infra
        terraform fmt -check

    - name: 'Terraform Validate'
      id: validate
      run: |
        cd infra
        terraform validate

    - name: 'Terraform Plan'
      id: plan
      run: |
        cd infra
        terraform plan -out=tfplan

    # - name: 'Approval for TF apply'
    #   uses: chetan/invoke-approval-action@v2
    #   with:
    #     GITHUB_TOKEN: ${{ secrets.PAT_TOKEN_GITHUB }}
    #     message: 'Please review and approve the Terraform plan.'
    #     timeout_minutes: 30


    - name: 'Terraform Apply'
      id: apply
      if: github.ref == 'refs/heads/main'
      run: |
        cd infra
        terraform apply -auto-approve tfplan
